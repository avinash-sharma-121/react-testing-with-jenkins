@Library("shared") _
pipeline {
    agent any

    environment {
        DOCKER_USERNAME = "avisharma82"
        DOCKER_IMAGE_NAME = "react_test_app"
    }

    stages {

        stage('Code Pull') {
            steps {
                script {
                    git_checkout(
                        "https://github.com/avinash-sharma-121/react-testing-with-jenkins.git",
                        "main"
                    )
                }
            }
        }

        stage('Generate Image Tag') {
            steps {
                script {
                    env.GIT_SHA = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()

                    env.IMAGE_Full_name = "${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:${env.GIT_SHA}"

                    echo "GIT SHA: ${env.GIT_SHA}"
                    echo "IMAGE: ${env.IMAGE_Full_name}"
                }
            }
        }

        stage('Docker Image Build') {
            steps {
                script {
                    docker_image_creation(
                        DOCKER_USERNAME,
                        DOCKER_IMAGE_NAME,
                        env.GIT_SHA
                    )
                }
            }
        }

        stage ('trivy scaner report'){
            steps{
                script {
                    echo "Scanning image with trivy scanner"
                    sh  "trivy --version"
                    sh  "trivy image --severity LOW,HIGH,CRITICAL ${env.IMAGE_Full_name}"
                    echo "Trivy scan completed"
                }
            }
        }

        stage ('trivy scaner pass/fail'){
            steps{
                script {
                    echo "Scanning image with trivy scanner"
                    echo "Image to scan: ${env.IMAGE_Full_name}"
                    try{
                    sh  "trivy --version"
                    sh  "trivy image --exit-code 1 --severity CRITICAL ${env.IMAGE_Full_name}"
                    echo "Trivy scan pass all vulnerabilities"
                    }
                    catch (err){
                        echo "Trivy scan failed due to CRITICAL vulnerabilities"
                        error("Security gate failed due to Trivy scan")
                    }
                }
            }
        }
        
        stage('Push Image to DockerHub') {
            steps {
                script {
                    push_img_to_dockerHub(
                        DOCKER_USERNAME,
                        DOCKER_IMAGE_NAME,
                        env.GIT_SHA
                    )
                }
            }
        }

/*       //comented for CD pipeline trigger
        stage('code deploy'){
            steps{
                script{
                echo "code deploy with docker"
                sh """
                export Docker_Image=${env.IMAGE_Full_name}
                docker-compose down
                docker-compose up -d
                """
                }
            }
        } 
*/
    }

    post {
        success {
        echo "POST CHECK → GIT_SHA = '${env.GIT_SHA}'"
        echo "POST CHECK → IMAGE_Full_name = '${env.IMAGE_Full_name}'"

            build job: 'React_project_CD_pipeline',
                  parameters: [
                      string(name: 'DOCKER_IMAGE', value: env.IMAGE_Full_name),
                      string(name: 'APP_VERSION', value: env.GIT_SHA)
                      //string(name: 'DOCKER_IMAGE', value: "${env.IMAGE_Full_name}"),
                      //string(name: 'APP_VERSION', value: "${env.GIT_SHA}")
                  ],
        wait: true,      // Set to false to trigger and move on without waiting
        propagate: true  // If true, the CI job fails if the CD job fails
        }
    }
    
}
