@Library("shared") _
pipeline {
    agent any

    environment{
        Docker_username = "avisharma82"
        Docker_image_name = "react_test_app"
    }

    stages{
        stage('code pull'){
            steps{
                script{
                    git_checkout("https://github.com/avinash-sharma-121/react-testing-with-jenkins.git","main")
                }
            }
        }

        stage('generate image tag'){
            steps{
                script{
                    GIT_SHA = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    echo "GIT SHA is ${GIT_SHA}"
                    IMAGE_Full_name = "${Docker_username}/${Docker_image_name}:${GIT_SHA}"
                    echo "Docker IMAGE full name is ${IMAGE_Full_name}"
                }
            }
        }

        stage('docker image build'){
            steps{
                  script{
                      docker_image_creation(Docker_username,Docker_image_name,GIT_SHA)    
                  }
            }
        }

        stage('image push to dockerhub'){
            steps{
                  script{
                      push_img_to_dockerHub(Docker_username,Docker_image_name,GIT_SHA)
                  }
                }
        }
        //comented for CD pipeline trigger
       /* stage('code deploy'){
            steps{
                script{
                echo "code deploy with docker"
                sh """
                export Docker_Image=${IMAGE_Full_name}
                docker-compose down
                docker-compose up -d
                """
                }
            }
        } */
    }

    post{
        success{
            build job: 'React_project_CD_pipeline'
            parameters: [
                //string(name: 'DEPLOY_ENV', value: 'prod'),
                string(name: 'DOCKER_IMAGE', value: IMAGE_Full_name),
                string(name: 'APP_VERSION', value: GIT_SHA)
            ]
        }
    }
}
